name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    name: Build ${{ matrix.platform }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: android
            artifact_name: android-apk
          - os: windows-latest
            platform: windows
            artifact_name: windows-exe
          - os: ubuntu-latest
            platform: linux
            artifact_name: linux-assets

    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.41.0'
          channel: 'stable'

      - name: Get version from tag
        id: version
        # Extracts '1.0.8' from 'refs/tags/v1.0.8'
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Get dependencies
        run: flutter pub get

      - name: Install Linux dependencies
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libstdc++-12-dev

      - name: Build Android
        if: matrix.platform == 'android'
        run: flutter build apk --release

      - name: Build Windows
        if: matrix.platform == 'windows'
        run: flutter build windows --release

      - name: Build Linux (Binary & Deb)
        if: matrix.platform == 'linux'
        run: |
          # 1. Build the standard Linux release
          flutter build linux --release
          
          # 2. Prepare a staging area for artifacts
          mkdir -p build/linux-artifacts
          
          # 3. Copy the raw binary
          cp build/linux/x64/release/bundle/project1_flutter build/linux-artifacts/
          
          # 4. Build the .deb package
          mkdir -p build/linux-deb/DEBIAN
          mkdir -p build/linux-deb/usr/local/bin/project1_flutter
          cp -r build/linux/x64/release/bundle/* build/linux-deb/usr/local/bin/project1_flutter/
          
          cat > build/linux-deb/DEBIAN/control << EOF
          Package: project1-flutter
          Version: ${{ steps.version.outputs.VERSION }}
          Section: utils
          Priority: optional
          Architecture: amd64
          Depends: libc6, libgtk-3-0
          Maintainer: Your Name
          Description: project1 Flutter Application
          EOF
          
          chmod -R 755 build/linux-deb/usr
          dpkg-deb --build build/linux-deb build/linux-artifacts/project1-flutter_${{ steps.version.outputs.VERSION }}_amd64.deb

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          # Path logic: Linux uses the staging folder, others use specific build files
          path: |
            ${{ matrix.platform == 'android' && 'build/app/outputs/flutter-apk/app-release.apk' || '' }}
            ${{ matrix.platform == 'windows' && 'build/windows/x64/runner/Release/project1_flutter.exe' || '' }}
            ${{ matrix.platform == 'linux' && 'build/linux-artifacts/' || '' }}
          retention-days: 2

  release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare Assets for Upload
        run: |
          mkdir -p upload
          
          # Android: Rename and move
          cp artifacts/android-apk/app-release.apk upload/project1-${{ github.ref_name }}-android.apk
          
          # Windows: Rename and move
          cp artifacts/windows-exe/project1_flutter.exe upload/project1-${{ github.ref_name }}-windows.exe
          
          # Linux: Binary
          cp artifacts/linux-assets/project1_flutter upload/project1-${{ github.ref_name }}-linux-binary
          
          # Linux: Deb (using wildcard to catch the dynamic version name)
          cp artifacts/linux-assets/*.deb upload/project1-${{ github.ref_name }}-linux.deb

      - name: Create and Upload Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref }}
          name: Release ${{ github.ref_name }}
          draft: false
          prerelease: false
          files: upload/*
          body: |
            ## Downloads
            
            Find the attached assets below for your platform:
            * **Android**: `.apk`
            * **Windows**: `.exe` 
            * **Linux**: Portable binary and `.deb` package
            
            ---
            **Build Info**
            - Tag: ${{ github.ref_name }}
            - Flutter Version: 3.41.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
